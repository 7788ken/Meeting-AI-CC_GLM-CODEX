# Codex 审阅文档

本文档用于规范在本仓库（Meeting-AI Monorepo）中使用 Codex CLI 进行代码审阅（Code Review）的流程、清单与记录方式，目标是提升一致性、可追溯性与缺陷发现率。

## 1. 适用范围

- 前端：`frontend/`（Vue 3 + Vite + TypeScript）
- 后端：`backend/`（NestJS + Prisma + PostgreSQL + MongoDB）
- 交付物：代码变更、配置变更、脚本与文档变更（含接口契约与数据模型）

## 2. 审阅目标（优先级从高到低）

1. 正确性：行为符合需求与边界条件；避免回归。
2. 安全性：认证/鉴权/输入输出校验/敏感信息处理符合预期。
3. 可维护性：SOLID/KISS/DRY/YAGNI；清晰的模块边界；可读、可测。
4. 可观测性：关键路径有必要日志与错误上下文；可定位问题。
5. 性能与资源：避免明显的 N+1、阻塞、重复计算与不必要的 IO。

## 3. Codex 审阅工作流

### 3.1 变更前信息收集（作者或审阅者）

- 明确变更动机：需求/缺陷/重构/性能优化（对应任务链接或说明）。
- 明确影响面：入口点、依赖模块、数据模型、接口契约、配置与运行方式。
- 明确验证方式：本地可复现步骤、最小化验证命令、关键用例。

### 3.2 Codex 审阅指令建议（可直接复制使用）

按变更类型选择最小输入集，避免“全仓库泛扫”带来的噪音：

- 仅看 Diff（推荐作为第一步）
  - `codex @<改动文件1> @<改动文件2> 请基于变更做代码审阅：指出逻辑错误、潜在安全问题、边界条件、可维护性问题，并给出可落地的修改建议。`
- 追踪影响面（当涉及跨模块/接口/数据）
  - `codex @<入口文件> @<核心模块> @<相关DTO/Schema> 评估此次改动的影响范围：接口兼容性、数据一致性、错误处理与回滚策略。`
- 生成“审阅结论草稿”（用于 PR 描述/审阅记录）
  - `codex @<改动文件...> 输出：关键风险点（按严重度排序）、必须修改项、建议修改项、验证清单。`

说明：
- `<...>` 替换为实际路径；尽量只包含与变更强相关的文件。
- 若需要上下文，可追加：路由/Controller、Service、数据访问层、关键组件与状态管理文件。

### 3.3 审阅输出要求（对人类友好）

- 将问题按严重度分级：`阻断（Blocker）/高（High）/中（Medium）/低（Low）`
- 每个问题必须包含：定位（文件/函数/模块）、原因、影响、可执行建议（必要时给出修改片段）
- 明确哪些建议属于“YAGNI”：避免超出本次需求范围的扩展

## 4. 审阅检查清单

### 4.1 通用（前后端均适用）

- 需求对齐：是否覆盖最关键的成功路径与失败路径（空值、越界、重复请求、并发、权限不足）。
- 错误处理：异常路径是否可控；错误信息是否泄露敏感信息；是否保留足够上下文。
- API 兼容性：入参/出参/状态码/字段语义是否一致；是否需要版本兼容或迁移策略。
- 可测试性：逻辑是否可在单测中隔离；避免把复杂逻辑塞进框架胶水层。
- 测试隔离：测试中 mock/patch 全局对象（`document`/`URL`/`navigator` 等）必须在用例结束后 restore，避免跨用例/跨文件污染。
- DRY/KISS：是否出现明显重复与过度抽象；是否存在“为了未来”而引入的复杂度。
- 依赖与配置：是否引入不必要依赖；配置是否有默认值与失败提示；环境变量是否有说明。

### 4.2 前端（`frontend/`）

- 状态管理：Pinia 状态是否最小化、可追踪；避免跨层隐式耦合。
- 组件边界：组件职责单一；props/emit 清晰；副作用集中在合适生命周期。
- 类型安全：关键数据结构有明确类型；避免 `any` 扩散；接口 DTO 与后端字段一致。
- 安全：DOM 注入与 XSS（富文本/HTML 渲染）风险评估；用户输入是否净化。
- 交互与错误提示：异步请求 loading/error 状态完整；失败可恢复；避免静默失败。

### 4.3 后端（`backend/`）

- 分层与依赖：Controller 只做编排；业务逻辑在 Service；数据访问集中且可替换。
- 路由匹配：通配符路由（如 `GET /:id`）必须声明在更具体路由之后，避免误匹配（例如把 `session` 当作 `id`）。
- 校验与鉴权：DTO 校验（class-validator）；鉴权/权限校验是否覆盖敏感接口。
- 事务与一致性：涉及多写时是否需要事务；跨存储（PostgreSQL/MongoDB）一致性策略是否明确。
- Prisma/Mongoose 使用：避免 N+1；查询条件与索引匹配；分页/排序参数校验。
- WebSocket：连接鉴权、心跳、断线重连策略、广播范围控制。

### 4.4 数据库与迁移（若涉及）

- Prisma schema 变更是否配套迁移与回滚考虑；字段默认值与非空约束合理。
- 数据兼容：老数据读写是否仍可用；是否需要一次性数据修复脚本（如确需，记录执行方式与风险）。

## 5. 最小化验证命令（按需选择）

- 前端：`pnpm --dir frontend test`、`pnpm --dir frontend lint`、`pnpm --dir frontend build`
- 后端：`pnpm --dir backend test`、`pnpm --dir backend lint`、`pnpm --dir backend build`

约定：
- 优先跑与本次改动相关的最小集合；若涉及核心路径或公共模块，建议补充全量单测。

## 6. 本文档维护规则（持续维护）

触发更新的情形（满足任一即更新本文件）：

- 工程结构发生变化（目录结构、关键模块拆分/合并、入口点调整）。
- 质量门槛变化（新增/调整 lint、测试、构建、CI 规则）。
- 发现高频审阅问题（可沉淀为“必查项”或“反例”）。
- 依赖与安全策略更新（认证方式、权限模型、输入净化策略、敏感信息规范）。

维护方式：

- 每次引入新模式/新约定时：在对应清单处补充一条可执行规则。
- 每次出现严重线上/联调问题回溯：追加到“审阅记录”中，并抽象为检查清单项（避免只记录个案）。

## 7. 审阅记录（建议每次重要合并后补一条）

| 日期 | 变更范围 | 结论 | 风险点 | 跟进项 |
|---|---|---|---|---|
| 2026-01-17 | 并发与链路同步（新增）Review | 发现会话级覆盖与调度并发问题，需补齐限流与任务粒度 | analysis/translation scheduleKey 颗粒度不当导致丢任务；分段调度无全局并发上限；冷却叠加放大退避；WS 断线回滚滞后 | 拆分 scheduleKey 粒度与去重策略；增加分段调度并发上限；统一退避；WS 断线即时回滚 |
| 2026-01-17 | 前后端录音→转写→拆分→翻译→分析全链路 | 修复 HTTPS 默认 ws 协议与启动回滚问题；前端单测通过 | 混合内容阻断导致 WS 连接失败；start_transcribe 未回滚；采集中途错误状态不一致；拆分窗口无法命中前序句导致停滞；Socket.IO 网关/RecordButton 可能冗余 | 补齐采集中途错误的 stopTranscribe/状态同步；拆分失败自动扩大窗口或触发重建；确认并清理冗余模块 |
| 2026-01-10 | 后端路由/鉴权/测试、前端单测 | 修复路由误匹配、补齐 E2E 鉴权、修复默认用户初始化竞态与 ID 冲突、增强测试隔离、移除子项目锁文件 | `GET /:id` 误匹配特定路由；全局 mock 污染导致用例互相影响；默认用户异步创建导致登录不稳定 |  |

## 8. 待修复/疑问/待讨论（滚动）

- 待跟进：基于 queueDelay P50/P95 指标评估是否需要调整全局 + 桶双层排队策略。`backend/src/common/llm/glm-rate-limiter.ts` `backend/src/main.ts`
- 待讨论：`TranscriptGateway`(socket.io) 与原生 WebSocket 并存是否保留。`backend/src/modules/transcript/transcript.gateway.ts`
- 待讨论：`RecordButton` 是否仍有使用场景。`frontend/src/components/RecordButton.vue`

## 9. 相关文档（避免重复造轮子）

- 开发流程与规范：`Readme/代码规范和开发流程.md`
- 测试策略：`Readme/测试策略和测试用例设计规范.md`
- API 规范：`Readme/API接口规范文档.md`
- 架构与模块：`Readme/系统架构设计文档.md`、`Readme/模块设计文档.md`
