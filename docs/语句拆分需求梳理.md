# 语句拆分需求梳理与差距分析

> 目标：明确“语句拆分”（旧称“语义分段”）的实际实现与用户期望之间的偏差，作为后续重构依据。

## 1. 需求摘要（来自用户描述，已澄清）

- 在 meeting 页面中的“语句拆分”栏目，数据顺序倒置：新内容应在最上。
- 逻辑需重构：从数据库表 `transcript_events` 按窗口值（配置在 `.env`）取上下文，发送给语句拆分服务（GLM4.6flash），结果写入数据库表 `transcript_events_segments`。
- 核心链路：触发时取“上一句 A + 当前上下文 B”，由 LLM 推理下一句 C 并落库；再次触发用 C + B1 推理 D，循环生成，前端可看到完整对话。

## 2. 当前实现概览（事实）

### 2.1 现有模块与职责

- 语句拆分（现实现，旧称语义分段）：`backend/src/modules/transcript-analysis/`
  - `TranscriptAnalysisService`：按 `targetEventIndex` 逐条分析事件。
  - `buildTranscriptAnalysisPrompt`：强约束“只做结构化、不改写、同 speaker 连续合并”。
  - `validateAndNormalizeDialogues`：强校验“同 speaker 连续、覆盖目标事件”。
  - 落库集合：`transcript_analysis_chunks`。
- 原文事件流：`backend/src/modules/transcript-stream/`
  - 数据源为 `transcript_events`，提供窗口查询与快照。
- 轮次分段（另一个模块）：`backend/src/modules/turn-segmentation/`
- 与“语句拆分”概念易混淆，但目标是按说话人轮次切段。

### 2.2 当前处理流程（简化）

1. 从 `transcript_events` 取窗口 `[targetEventIndex - window, targetEventIndex + window]`。
2. 调用 GLM，返回结构化 `dialogues`（按 speaker 连续合并、禁止改写）。
3. 校验并落库到 `transcript_analysis_chunks`。
4. 前端目前未见对 `transcript_analysis_upsert` 的订阅与展示。

## 3. 与期望的关键差距

### 3.1 数据模型不一致

- 期望集合：`transcript_events_segments`（不存在）。
- 实际集合：`transcript_analysis_chunks`（只保存结构化分段结果）。

### 3.2 生成逻辑不一致

- 期望：基于“上一句 + 当前上下文”推理出“下一句”，并持续链式生成新句子。
- 实际：仅对窗口内已有事件做结构化分段，不生成新内容。

### 3.3 输出内容与用途不一致

- 期望：生成完整对话（可持续补全）。
- 实际：输出分段 + 可选纠错内容（`correctedContent`），强调不可改写。

### 3.4 “语句拆分”定义混乱（旧称“语义分段”）

当前存在两个相似模块：
- `transcript-analysis`：被称为“语句拆分”（旧称“语义分段”），但实际是结构化分段。
- `turn-segmentation`：按 speaker turn 分段，与语句拆分在概念上重叠。

## 4. “顺序倒置”问题初判

- `getSessionAnalysis` 已按 `startEventIndex/endEventIndex` 升序返回（后端无倒序）。
- 若前端显示“新在上”，更可能来自：
  - 前端排序/渲染逻辑；
  - 查询无排序导致的不稳定顺序；
  - 使用 `createdAt` 倒序拉取。
- meeting 页面“语句拆分”现使用 `TranscriptEventSegmentsPanel` 渲染 `transcript_events_segments`；按 `sequence` 倒序展示，满足“新在上”。

## 5. 需澄清的关键问题

1. “语句拆分”要基于哪个现有模块重构：`transcript-analysis` 还是新增服务？
2. `transcript_events_segments` 的字段与幂等规则是否有明确约定？
3. “上一句 A + 当前上下文 B -> 推理下一句 C”的输出内容是否允许改写/补写？
4. “顺序倒置”具体发生在：哪个接口、哪个页面或集合？

## 6. 结论

当前实现是“结构化分段”，不生成新语句；与“链式生成下一句”的目标存在核心偏差。需要明确目标数据模型与触发链路后，才能进行可验证的重构。

## 7. 已落地改动（本次）

- 前端：meeting 页“语句拆分”改为展示 `transcript_events_segments` 的结果，新内容按 `sequence` 倒序显示。
- 后端：新增 `transcript-event-segmentation` 模块，基于 `transcript_events` 窗口 + 上一句内容生成下一句并落库到 `transcript_events_segments`。
- 通道：新增 WS 消息 `transcript_event_segment_upsert` 与快照接口 `GET /transcript-event-segmentation/session/:sessionId`。
- 轮次分段：新增开关 `TRANSCRIPT_SEGMENT_ENABLED`，默认关闭以便“备份不用”。
