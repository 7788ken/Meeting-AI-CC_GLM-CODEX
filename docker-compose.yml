# === 使用说明 ===
#
# 开发模式（仅启动数据库）：
#   docker compose --profile dev up
#
# 生产模式（启动全部服务）：
#   docker compose --profile prod up
#   或：docker compose up
#
# 停止并清理：
#   docker compose down
#   docker compose down -v  # 同时删除数据卷

services:
  # PostgreSQL 数据库（Prisma ORM：会话、用户等）
  postgres:
    image: postgres:15-alpine
    container_name: meeting-ai-postgres
    profiles: [dev, prod]
    environment:
      POSTGRES_USER: quickchatbox
      POSTGRES_PASSWORD: quickchatbox
      POSTGRES_DB: meeting_ai
    ports:
      - '5432:5432'
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/001_init.sql:ro
    networks:
      - meeting-ai-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U quickchatbox']
      interval: 5s
      timeout: 5s
      retries: 5

  # MongoDB 数据库（Mongoose：Speech / Analysis / transcript_events / turn_segments）
  mongo:
    image: mongo:6
    container_name: meeting-ai-mongo
    profiles: [dev, prod]
    ports:
      - '27017:27017'
    volumes:
      - mongo-data:/data/db
    networks:
      - meeting-ai-network
    healthcheck:
      test: ['CMD', 'mongosh', '--eval', 'db.adminCommand("ping")']
      interval: 5s
      timeout: 5s
      retries: 5

  # === 生产模式：后端服务 ===
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: meeting-ai-backend
    profiles: [prod]
    environment:
      NODE_ENV: production
      PORT: 5181
      API_PREFIX: api
      CORS_ORIGIN: '*'
      DATABASE_URL: postgresql://quickchatbox:quickchatbox@postgres:5432/meeting_ai
      MONGODB_URI: mongodb://mongo:27017/meeting_ai
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
      # GLM 配置
      GLM_API_KEY: ${GLM_API_KEY}
      GLM_ENDPOINT: ${GLM_ENDPOINT}
    ports:
      - '5181:5181'
    depends_on:
      postgres:
        condition: service_healthy
      mongo:
        condition: service_healthy
    networks:
      - meeting-ai-network
    restart: unless-stopped

  # === 生产模式：前端服务 ===
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: meeting-ai-frontend
    profiles: [prod]
    ports:
      - '80:80'
    depends_on:
      - backend
    networks:
      - meeting-ai-network
    restart: unless-stopped

volumes:
  postgres-data:
  mongo-data:

networks:
  meeting-ai-network:
    driver: bridge
